<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose</title>
    <link rel="icon" type="image/png" href="{{logo_path}}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-brown: #6f5c4b;
            --primary-brown-darker: #5a4a3c;
            --primary-brown-lighter: #8a7663;
            --primary-brown-light: #cfc0b3;
            --primary-brown-lightest: #f4f0eb;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            background-image: url("{{dynamic_background}}");
        }

        .title-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .title-container img {
            width: 50px;
            height: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-brown);
        }

        input,
        textarea,
        select {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid var(--primary-brown-light);
            border-radius: 4px;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-brown);
            box-shadow: 0 0 0 2px var(--primary-brown-light);
        }

        button {
            padding: 10px 20px;
            background-color: var(--primary-brown);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            position: relative;
            transition: all 0.1s ease;
            box-shadow: 0 4px 0 var(--primary-brown-darker);
            transform: translateY(0);
        }

        button:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--primary-brown-darker);
        }

        button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 var(--primary-brown-darker);
        }

        .icon-btn {
            padding: 5px 5px;
            min-width: 50px;
            height: auto;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.1s ease;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
            transform: translateY(0);
        }

        .icon-btn:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2);
        }

        .icon-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
        }

        .icon-btn i {
            font-size: 1.5em;
        }

        .icon-btn i+span {
            margin-left: 5px;
        }

        .whatsapp-btn {
            background-color: #25D366;
            box-shadow: 0 4px 0 #1da851;
        }

        .whatsapp-btn:hover {
            background-color: #1da851;
            box-shadow: 0 2px 0 #1da851;
        }

        .whatsapp-btn:active {
            box-shadow: 0 0 0 #1da851;
        }

        .slack-btn {
            background-color: #b03bb2;
            box-shadow: 0 4px 0 #9a349c;
        }

        .slack-btn:hover {
            background-color: #9a349c;
            box-shadow: 0 2px 0 #9a349c;
        }

        .slack-btn:active {
            box-shadow: 0 0 0 #9a349c;
        }

        .instagram-btn {
            background-color: #E4405F;
            box-shadow: 0 4px 0 #c13554;
        }

        .instagram-btn:hover {
            background-color: #c13554;
            box-shadow: 0 2px 0 #c13554;
        }

        .instagram-btn:active {
            box-shadow: 0 0 0 #c13554;
        }

        .telegram-btn {
            background-color: #0088cc;
            box-shadow: 0 4px 0 #0077b3;
        }

        .telegram-btn:hover {
            background-color: #0077b3;
            box-shadow: 0 2px 0 #0077b3;
        }

        .telegram-btn:active {
            box-shadow: 0 0 0 #0077b3;
        }

        .twitter-btn {
            background-color: #1DA1F2;
            box-shadow: 0 4px 0 #1a8cd8;
        }

        .twitter-btn:hover {
            background-color: #1a8cd8;
            box-shadow: 0 2px 0 #1a8cd8;
        }

        .twitter-btn:active {
            box-shadow: 0 0 0 #1a8cd8;
        }

        .qr-btn {
            background-color: #6c757d;
            box-shadow: 0 4px 0 #5a6268;
        }

        .qr-btn:hover {
            background-color: #5a6268;
            box-shadow: 0 2px 0 #5a6268;
        }

        .qr-btn:active {
            box-shadow: 0 0 0 #5a6268;
        }

        .paste-btn {
            background-color: #6c757d;
        }

        .paste-btn:hover {
            background-color: #5a6268;
        }

        .image-btn {
            background-color: var(--primary-brown);
        }

        .image-btn:hover {
            background-color: var(--primary-brown-darker);
        }

        #result {
            margin-top: 20px;
            text-align: center;
            padding: 10px;
            background: white;
        }

        #result canvas {
            max-width: 100%;
            display: block;
            margin: 0 auto;
            border: 1px solid #ddd;
        }

        .qr-section {
            padding: 15px;
            background: white;
            border: 1px solid var(--primary-brown-light);
            border-radius: 4px;
            min-width: 200px;
            text-align: center;
        }

        .qr-section h3 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: var(--primary-brown);
        }

        .help-text {
            font-size: 0.9em;
            color: var(--primary-brown);
            margin-top: 5px;
        }

        .size-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .size-inputs input {
            width: 80px;
            text-align: center;
        }

        .size-inputs span {
            font-size: 1.2em;
            color: var(--primary-brown);
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .copy-btn {
            background-color: var(--primary-brown);
        }

        .copy-btn:hover {
            background-color: var(--primary-brown-darker);
        }

        .api-url-container {
            margin-top: 20px;
            padding: 10px;
            background: var(--primary-brown-lightest);
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            gap: 20px;
            align-items: flex-start;
            border: 1px solid var(--primary-brown-light);
        }

        .api-url-content {
            flex: 1;
        }

        .api-url-input {
            font-family: monospace;
            font-size: 0.9em;
            background: white;
            border: 1px solid var(--primary-brown-light);
            padding: 8px;
            margin-bottom: 5px;
            width: 100%;
            box-sizing: border-box;
        }

        .copy-message {
            color: #28a745;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .collections-link {
            margin-left: auto;
            padding: 8px 15px;
            background-color: #d4c4b5;
            color: #6f5c4b;
            text-decoration: none;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            transition: all 0.1s ease;
            box-shadow: 0 4px 0 #c0b2a4;
            transform: translateY(0);
        }

        .collections-link:hover {
            background-color: #c0b2a4;
            box-shadow: 0 2px 0 #c0b2a4;
            transform: translateY(2px);
            color: #6f5c4b;
        }

        .collections-link:active {
            box-shadow: 0 0 0 #c0b2a4;
            transform: translateY(4px);
        }

        .collections-link i {
            font-size: 1.2em;
        }

        .properties-form input[type="color"] {
            padding: 0 2px;
        }

        .save-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .save-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }

        .save-modal h2 {
            margin-top: 0;
        }

        .save-modal input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }

        .save-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .save-modal-buttons button {
            padding: 8px 15px;
        }

        .save-modal-buttons .cancel-btn {
            background-color: #6c757d;
            box-shadow: 0 4px 0 #5a6268;
        }

        .save-modal-buttons .cancel-btn:hover {
            background-color: #5a6268;
            box-shadow: 0 2px 0 #5a6268;
        }

        .save-modal-buttons .cancel-btn:active {
            box-shadow: 0 0 0 #5a6268;
        }

        .save-modal-buttons .save-btn {
            background-color: #d4c4b5;
            color: #6f5c4b;
            box-shadow: 0 4px 0 #c0b2a4;
        }

        .save-modal-buttons .save-btn:hover {
            background-color: #c0b2a4;
            box-shadow: 0 2px 0 #c0b2a4;
        }

        .save-modal-buttons .save-btn:active {
            box-shadow: 0 0 0 #c0b2a4;
        }

        .content-length-warning {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .content-length-info {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .qr-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .qr-modal h3 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            color: #666;
        }

        #qrCode {
            width: 400px;
            height: 400px;
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            margin: 0 auto;
        }

        .qr-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .qr-modal-buttons button {
            padding: 8px 15px;
        }

        .qr-modal-buttons .close-btn {
            background-color: #6c757d;
            box-shadow: 0 4px 0 #5a6268;
        }

        .qr-modal-buttons .close-btn:hover {
            background-color: #5a6268;
            box-shadow: 0 2px 0 #5a6268;
        }

        .qr-modal-buttons .close-btn:active {
            box-shadow: 0 0 0 #5a6268;
        }

        .svg-editor {
            margin-top: 20px;
        }

        .editor-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 15px;
        }

        .preview-container {
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .preview-container h3 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #666;
        }

        #svg-preview {
            width: 100%;
            height: 300px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #preview-canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        #svg-code {
            width: 100%;
            height: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
            background: #f8f9fa;
        }

        .editor-tools {
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .tool-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .tool-section h3 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #666;
        }

        .tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tool-buttons button {
            background-color: #d4c4b5;
            color: #6f5c4b;
            border: none;
            box-shadow: 0 4px 0 #c0b2a4;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            position: relative;
            transition: all 0.1s ease;
            transform: translateY(0);
        }

        .tool-buttons button:hover {
            background-color: #c0b2a4;
            box-shadow: 0 2px 0 #c0b2a4;
            transform: translateY(2px);
        }

        .tool-buttons button:active {
            box-shadow: 0 0 0 #c0b2a4;
            transform: translateY(4px);
        }

        .saveToServer-btn,
        .download-btn {
            background-color: #d4c4b5;
            color: #6f5c4b;
            box-shadow: 0 4px 0 #c0b2a4;
        }

        .saveToServer-btn:hover,
        .download-btn:hover {
            background-color: #c0b2a4;
            box-shadow: 0 2px 0 #c0b2a4;
        }

        .saveToServer-btn:active,
        .download-btn:active {
            box-shadow: 0 0 0 #c0b2a4;
        }

        .properties-form button {
            background-color: #d4c4b5;
            color: #6f5c4b;
            box-shadow: 0 4px 0 #c0b2a4;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            position: relative;
            transition: all 0.1s ease;
            transform: translateY(0);
        }

        .properties-form button:hover {
            background-color: #c0b2a4;
            box-shadow: 0 2px 0 #c0b2a4;
            transform: translateY(2px);
        }

        .properties-form button:active {
            box-shadow: 0 0 0 #c0b2a4;
            transform: translateY(4px);
        }

        #no-selection-message {
            color: #999;
            font-style: italic;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .editor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .elements-list {
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .element-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .element-item:last-child {
            border-bottom: none;
        }

        .element-item:hover {
            background-color: #f0f0f0;
        }

        .element-item.selected {
            background-color: #e3f2fd;
            border-left: 3px solid #007bff;
        }

        .element-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            color: white;
            background-color: #6c757d;
            margin-right: 8px;
        }

        .element-type.text {
            background-color: #28a745;
        }

        .element-type.image {
            background-color: #fd7e14;
        }

        .element-type.rect {
            background-color: #dc3545;
        }

        .element-type.circle {
            background-color: #007bff;
        }

        .element-type.path {
            background-color: #6610f2;
        }

        .element-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .preview-header h3 {
            margin: 0;
        }

        .editor-actions button {
            padding: 8px 15px;
            background-color: #d4c4b5;
            color: #6f5c4b;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 4px 0 #c0b2a4;
        }

        .editor-actions button:hover {
            background-color: #c0b2a4;
            box-shadow: 0 2px 0 #c0b2a4;
        }

        .editor-actions button:active {
            box-shadow: 0 0 0 #c0b2a4;
        }

        .properties-form {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .properties-form .form-group {
            margin-bottom: 15px;
        }

        .properties-form .form-group:last-child {
            margin-bottom: 0;
            text-align: right;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .toast {
            background-color: #fff;
            color: #333;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
        }

        .toast.success {
            border-left: 4px solid #28a745;
        }

        .toast.error {
            border-left: 4px solid #dc3545;
        }

        .toast.warning {
            border-left: 4px solid #ffc107;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="toast-container"></div>
    <div class="title-container">
        <img src="{{logo_path}}" alt="Dyno Logo">
        <h1><span style="color: #ada08a;">pi-</span>Collage Generator</h1>
        <a href="{{collection_link}}" class="collections-link">
            <i class="fas fa-server"></i>
            <span>View Server Collections</span>
        </a>
    </div>

    <div class="api-url-container">
        <div class="api-url-content">
            <label for="apiUrl">IMAGE URL : <span id="baseUrl" style="font-family: monospace;"></span></label>
            <input type="text" id="apiUrl" class="api-url-input">
            <div class="controls">
                <button class="icon-btn whatsapp-btn" onclick="copyApiUrl('whatsapp')" title="Share to WhatsApp">
                    <i class="fab fa-whatsapp"></i>
                </button>
                <button class="icon-btn slack-btn" onclick="copyApiUrl('slack')" title="Share to Slack">
                    <i class="fab fa-slack"></i>
                </button>
                <button class="icon-btn instagram-btn" onclick="copyApiUrl('instagram')" title="Share to Instagram">
                    <i class="fab fa-instagram"></i>
                </button>
                <button class="icon-btn telegram-btn" onclick="copyApiUrl('telegram')" title="Share to Telegram">
                    <i class="fab fa-telegram"></i>
                </button>
                <button class="icon-btn twitter-btn" onclick="copyApiUrl('twitter')" title="Share to Twitter">
                    <i class="fab fa-twitter"></i>
                </button>
                <button class="icon-btn qr-btn" onclick="showQRModal()" title="Generate QR Code">
                    <i class="fas fa-qrcode"></i> <span>QR Code</span>
                </button>
            </div>
            <div id="copyMessage" class="copy-message">URL copied to clipboard!</div>
        </div>
    </div>

    <div id="qrModal" class="qr-modal">
        <div class="qr-modal-content">
            <h3>Share URL QR Code</h3>
            <div id="qrCode"></div>
            <div class="qr-modal-buttons">
                <button class="close-btn" onclick="hideQRModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="svg-editor" class="svg-editor">
        <div class="form-group">
            <label>Canvas Size:</label>
            <div class="size-inputs">
                <input type="number" id="width" value="400" min="50" max="2000">
                <span>×</span>
                <input type="number" id="height" value="400" min="50" max="2000">
            </div>
        </div>

        <div class="editor-container">
            <div class="preview-container">
                <div class="preview-header">
                    <h3>Preview</h3>
                    <div class="editor-actions">
                        <button class="icon-btn saveToServer-btn" onclick="showSaveModal()" title="Save to Server">
                            <i class="fas fa-cloud-arrow-up"></i> <span>Save to Server</span>
                        </button>
                        <button class="icon-btn download-btn" onclick="downloadImage()" title="Download">
                            <i class="fas fa-download"></i> <span>Download</span>
                        </button>
                    </div>
                </div>
                <div id="svg-preview">
                    <canvas id="preview-canvas"></canvas>
                </div>
                <textarea id="svg-code" readonly style="display: none;"></textarea>
                <div id="contentLengthWarning" class="content-length-warning">Content exceeds maximum length (2000
                    characters)</div>
                <div id="contentLengthInfo" class="content-length-info">Content length: <span
                        id="contentLength">0</span>/2000</div>
            </div>

            <div class="editor-tools">
                <div class="tool-section">
                    <h3>Add Element</h3>
                    <div class="tool-buttons">
                        <button onclick="addText()">
                            <i class="fas fa-font"></i>
                            <span>Text</span>
                        </button>
                        <button onclick="addImage()">
                            <i class="fas fa-image"></i>
                            <span>Image</span>
                        </button>
                        <button onclick="addRect()">
                            <i class="fas fa-square"></i>
                            <span>Rectangle</span>
                        </button>
                        <button onclick="addCircle()">
                            <i class="fas fa-circle"></i>
                            <span>Circle</span>
                        </button>
                        <button onclick="addPath()">
                            <i class="fas fa-draw-polygon"></i>
                            <span>Path</span>
                        </button>
                    </div>
                </div>

                <div class="tool-section">
                    <h3>Elements</h3>
                    <div id="elements-list" class="elements-list">
                        <div id="no-elements-message" style="padding: 10px; color: #999; font-style: italic;">No
                            elements added yet</div>
                    </div>
                </div>

                <div id="element-properties" class="tool-section">
                    <h3>Properties</h3>
                    <div id="no-selection-message">Select an element to edit its properties</div>
                    <!-- Properties will be dynamically added here -->
                </div>

                <div id="contentGroups">
                    <!-- Content items will be added here -->
                </div>
            </div>
        </div>
    </div>

    <div id="saveImageModal" class="save-modal">
        <div class="save-modal-content">
            <h2>Save Image</h2>
            <input type="text" id="imageName" placeholder="Enter image name">
            <div class="save-modal-buttons">
                <button class="cancel-btn" onclick="hideSaveImageModal()">Cancel</button>
                <button class="save-btn" onclick="saveImage()">Save</button>
            </div>
        </div>
    </div>

    <div id="saveTemplateModal" class="save-modal">
        <div class="save-modal-content">
            <h2>Save Template</h2>
            <input type="text" id="templateId" placeholder="Enter template name">
            <div class="save-modal-buttons">
                <button class="cancel-btn" onclick="hideSaveTemplateModal()">Cancel</button>
                <button class="save-btn" onclick="saveTemplate()">Save</button>
            </div>
        </div>
    </div>

    <script src="{{lz_string_lib_path}}"></script>
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script>
        let qrCode = null;
        let svgElements = [];
        let selectedElement = null;

        const baseUrlLabel = document.getElementById('baseUrl');
        const apiUrlInput = document.getElementById('apiUrl');
        const copyMessage = document.getElementById('copyMessage');
        const svgCodeLabel = document.getElementById('svg-code');
        const defaultErrorImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2ZmZTZlNiIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJyZWQiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkdlbmVyYXRpb24gRmFpbGVkPC90ZXh0Pjwvc3ZnPg==';

        // Helper function to ensure color is in #RRGGBB format
        function formatColor(color) {
            if (!color) return '#000000';
            if (color.startsWith('#')) {
                if (color.length === 4) { // #RGB format
                    return '#' + color[1] + color[1] + color[2] + color[2] + color[3] + color[3];
                }
                if (color.length === 7) { // #RRGGBB format
                    return color;
                }
            }
            return '#000000'; // Default to black if format is unknown
        }

        // Function to generate dynamic background
        function generateDynamicBackground() {
            const now = new Date();

            // Format date and time
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = String(now.getFullYear());
            const hours = String(now.getHours()).padStart(2, '0');
            const mins = String(now.getMinutes()).padStart(2, '0');
            const secs = String(now.getSeconds()).padStart(2, '0');

            // Create array of all characters
            const dateTimeStr = `${day}${month}${year}-${hours}${mins}${secs}`;
            const chars = dateTimeStr.split('');

            // Number of lines equals number of characters plus one (for the last line)
            const numLines = chars.length;

            // Create SVG for background
            let lineElements = '';
            let textElements = '';
            const baseColor = '#6f5c4b';

            // Define SVG boundaries
            const SVG_WIDTH = 200;
            const SVG_HEIGHT = 200;

            // Calculate line width and spacing
            const lineWidth = 1;
            const spacing = SVG_WIDTH / numLines;

            // Initialize or update character positions and directions
            if (!window.charPositions) {
                window.charPositions = {};
            }
            if (!window.charDirections) {
                window.charDirections = {};
            }

            // Generate vertical lines with time-based positioning
            for (let i = 0; i < numLines; i++) {
                // Calculate x position ensuring lines are evenly spaced
                const x = i * spacing;
                const opacity = 0.1;

                lineElements += `<line 
                    x1="${x}" 
                    y1="0" 
                    x2="${x}" 
                    y2="${SVG_HEIGHT}" 
                    stroke="${baseColor}" 
                    stroke-width="${lineWidth}" 
                    stroke-opacity="${opacity}"/>`;

                // Add text elements in the gaps between lines
                if (i < chars.length) {
                    const gapStart = x + lineWidth;
                    const gapEnd = (i + 1) * spacing;
                    const gapWidth = gapEnd - gapStart;

                    // Position character horizontally in the center of the gap
                    const charX = gapStart + (gapWidth / 2) - 4; // -4 to center the character

                    // Get or initialize character position and direction
                    const charKey = `key_${i}`;
                    if (!window.charPositions[charKey]) {
                        window.charPositions[charKey] = 20 + (Math.random() * (SVG_HEIGHT - 40));
                        // Randomly assign initial direction (1 for down, -1 for up)
                        window.charDirections[charKey] = Math.random() > 0.5 ? 1 : -1;
                    } else {
                        // Move character by 0.1px in current direction
                        window.charPositions[charKey] += 0.1 * window.charDirections[charKey];

                        // Check boundaries and switch direction if needed
                        if (window.charPositions[charKey] > SVG_HEIGHT - 20) {
                            window.charPositions[charKey] = SVG_HEIGHT - 20;
                            window.charDirections[charKey] = -1; // Switch to moving up
                        } else if (window.charPositions[charKey] < 20) {
                            window.charPositions[charKey] = 20;
                            window.charDirections[charKey] = 1; // Switch to moving down
                        }
                    }

                    const charY = window.charPositions[charKey];

                    textElements += `<text 
                        x="${charX + 3}" 
                        y="${charY}" 
                        font-family="monospace" 
                        font-size="14" 
                        text-anchor="middle"
                        fill="${baseColor}" 
                        fill-opacity="0.1">${chars[i]}</text>`;
                }
            }

            // Create raw SVG content with lines and text
            const svgContent = `<svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                ${lineElements}
                ${textElements}
            </svg>`;

            // Convert SVG to data URL
            const svgDataUrl = `data:image/svg+xml,${encodeURIComponent(svgContent)}`;

            // Update the background style
            document.body.style.backgroundImage = `url("${svgDataUrl}")`;
        }

        // Initialize background and update it every 100ms for smoother animation
        generateDynamicBackground();
        setInterval(generateDynamicBackground, 1000);

        // Set the base URL on page load
        baseUrlLabel.textContent = `${window.location.origin}{{project_root_url}}`;

        // Initialize SVG editor
        document.addEventListener('DOMContentLoaded', function () {
            initSvgEditor();
            loadCollageFromId();
        });

        function initSvgEditor() {
            // Create initial SVG
            updateSvgPreview();

            // Add event listeners to size inputs
            document.getElementById('width').addEventListener('input', updateSvgPreview);
            document.getElementById('height').addEventListener('input', updateSvgPreview);

            // Initialize elements list
            updateElementsList();
        }

        function updateElementsList() {
            const listContainer = document.getElementById('elements-list');
            const noElementsMessage = document.getElementById('no-elements-message');

            // Clear the current list
            while (listContainer.firstChild) {
                listContainer.removeChild(listContainer.firstChild);
            }

            // Show message if no elements
            if (svgElements.length === 0) {
                listContainer.appendChild(noElementsMessage);
                return;
            }

            // Add each element to the list
            svgElements.forEach(element => {
                const elementItem = document.createElement('div');
                elementItem.className = 'element-item';
                elementItem.setAttribute('data-id', element.id);
                if (selectedElement && selectedElement.id === element.id) {
                    elementItem.classList.add('selected');
                }

                // Add element type badge
                const typeBadge = document.createElement('span');
                typeBadge.className = `element-type ${element.type}`;
                typeBadge.textContent = element.type.charAt(0).toUpperCase() + element.type.slice(1);

                // Add element name/description
                const nameSpan = document.createElement('span');
                nameSpan.className = 'element-name';
                let description = '';
                switch (element.type) {
                    case 'text':
                        description = element.text.substring(0, 20) + (element.text.length > 20 ? '...' : '');
                        break;
                    case 'image':
                        const urlParts = element.href.split('/');
                        description = urlParts[urlParts.length - 1];
                        break;
                    case 'rect':
                        description = `${element.width}×${element.height}`;
                        break;
                    case 'circle':
                        description = `r=${element.r}`;
                        break;
                    case 'path':
                        description = 'Path';
                        break;
                }
                nameSpan.textContent = description;

                // Assemble the element item
                elementItem.appendChild(typeBadge);
                elementItem.appendChild(nameSpan);

                // Add click event
                elementItem.addEventListener('click', () => {
                    const foundElement = svgElements.find(el => el.id === element.id);
                    if (foundElement) {
                        selectElement(foundElement);

                        // Update selected state in list
                        document.querySelectorAll('.element-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        elementItem.classList.add('selected');
                    }
                });

                listContainer.appendChild(elementItem);
            });
        }

        function addText() {
            const element = {
                type: 'text',
                id: 'text_' + Date.now(),
                x: 100,
                y: 100,
                text: 'Sample Text',
                fontSize: 24,
                fontFamily: 'Arial',
                fill: '#000000',
                textAnchor: 'middle'
            };

            svgElements.push(element);
            updateSvgPreview();
            selectElement(element);
            updateElementsList();
        }

        function addImage() {
            const element = {
                type: 'image',
                id: 'image_' + Date.now(),
                x: 50,
                y: 50,
                width: 100,
                height: 100,
                href: prompt('Enter image URL:') || 'https://via.placeholder.com/100'
            };

            svgElements.push(element);
            updateSvgPreview();
            selectElement(element);
            updateElementsList();
        }

        function addRect() {
            const element = {
                type: 'rect',
                id: 'rect_' + Date.now(),
                x: 50,
                y: 50,
                width: 100,
                height: 80,
                fill: '#a23',
                stroke: '#000',
                strokeWidth: 2,
                rx: 5,
                ry: 5
            };

            svgElements.push(element);
            updateSvgPreview();
            selectElement(element);
            updateElementsList();
        }

        function addCircle() {
            const element = {
                type: 'circle',
                id: 'circle_' + Date.now(),
                cx: 100,
                cy: 100,
                r: 50,
                fill: '#2a3',
                stroke: '#000',
                strokeWidth: 2
            };

            svgElements.push(element);
            updateSvgPreview();
            selectElement(element);
            updateElementsList();
        }

        function addPath() {
            const element = {
                type: 'path',
                id: 'path_' + Date.now(),
                d: 'M50,50 L150,50 L100,150 Z',
                fill: '#23a',
                stroke: '#000',
                strokeWidth: 2
            };

            svgElements.push(element);
            updateSvgPreview();
            selectElement(element);
            updateElementsList();
        }

        function selectElement(element) {
            selectedElement = element;

            // Update properties panel
            const propertiesPanel = document.getElementById('element-properties');
            propertiesPanel.innerHTML = '<h3>Properties</h3>';

            const form = document.createElement('div');
            form.className = 'properties-form';

            // Add common properties
            // form.innerHTML += `
            //     <div class="form-group">
            //         <label>ID</label>
            //         <input type="text" id="prop-id" value="${element.id}" readonly>
            //     </div>
            // `;

            // Add properties based on element type
            switch (element.type) {
                case 'text':
                    form.innerHTML += `
                        <div class="form-group">
                            <label>Text</label>
                            <input type="text" id="prop-text" value="${element.text}">
                        </div>
                        <div class="form-group">
                            <label>X Position</label>
                            <input type="number" id="prop-x" value="${element.x}">
                        </div>
                        <div class="form-group">
                            <label>Y Position</label>
                            <input type="number" id="prop-y" value="${element.y}">
                        </div>
                        <div class="form-group">
                            <label>Font Size</label>
                            <input type="number" id="prop-fontSize" value="${element.fontSize}">
                        </div>
                        <div class="form-group">
                            <label>Font Family</label>
                            <select id="prop-fontFamily">
                                <option value="Arial" ${element.fontFamily === 'Arial' ? 'selected' : ''}>Arial</option>
                                <option value="Verdana" ${element.fontFamily === 'Verdana' ? 'selected' : ''}>Verdana</option>
                                <option value="Times New Roman" ${element.fontFamily === 'Times New Roman' ? 'selected' : ''}>Times New Roman</option>
                                <option value="Courier New" ${element.fontFamily === 'Courier New' ? 'selected' : ''}>Courier New</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fill Color</label>
                            <input type="color" id="prop-fill" value="${formatColor(element.fill)}">
                        </div>
                        <div class="form-group">
                            <label>Text Anchor</label>
                            <select id="prop-textAnchor">
                                <option value="start" ${element.textAnchor === 'start' ? 'selected' : ''}>Start</option>
                                <option value="middle" ${element.textAnchor === 'middle' ? 'selected' : ''}>Middle</option>
                                <option value="end" ${element.textAnchor === 'end' ? 'selected' : ''}>End</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'image':
                    form.innerHTML += `
                        <div class="form-group">
                            <label>X Position</label>
                            <input type="number" id="prop-x" value="${element.x}">
                        </div>
                        <div class="form-group">
                            <label>Y Position</label>
                            <input type="number" id="prop-y" value="${element.y}">
                        </div>
                        <div class="form-group">
                            <label>Width</label>
                            <input type="number" id="prop-width" value="${element.width}">
                        </div>
                        <div class="form-group">
                            <label>Height</label>
                            <input type="number" id="prop-height" value="${element.height}">
                        </div>
                        <div class="form-group">
                            <label>Image URL</label>
                            <input type="text" id="prop-href" value="${element.href}">
                        </div>
                    `;
                    break;
                case 'rect':
                    form.innerHTML += `
                        <div class="form-group">
                            <label>X Position</label>
                            <input type="number" id="prop-x" value="${element.x}">
                        </div>
                        <div class="form-group">
                            <label>Y Position</label>
                            <input type="number" id="prop-y" value="${element.y}">
                        </div>
                        <div class="form-group">
                            <label>Width</label>
                            <input type="number" id="prop-width" value="${element.width}">
                        </div>
                        <div class="form-group">
                            <label>Height</label>
                            <input type="number" id="prop-height" value="${element.height}">
                        </div>
                        <div class="form-group">
                            <label>Corner Radius X</label>
                            <input type="number" id="prop-rx" value="${element.rx}">
                        </div>
                        <div class="form-group">
                            <label>Corner Radius Y</label>
                            <input type="number" id="prop-ry" value="${element.ry}">
                        </div>
                        <div class="form-group">
                            <label>Fill Color</label>
                            <input type="color" id="prop-fill" value="${formatColor(element.fill)}">
                        </div>
                        <div class="form-group">
                            <label>Stroke Color</label>
                            <input type="color" id="prop-stroke" value="${formatColor(element.stroke)}">
                        </div>
                        <div class="form-group">
                            <label>Stroke Width</label>
                            <input type="number" id="prop-strokeWidth" value="${element.strokeWidth}">
                        </div>
                    `;
                    break;
                case 'circle':
                    form.innerHTML += `
                        <div class="form-group">
                            <label>Center X</label>
                            <input type="number" id="prop-cx" value="${element.cx}">
                        </div>
                        <div class="form-group">
                            <label>Center Y</label>
                            <input type="number" id="prop-cy" value="${element.cy}">
                        </div>
                        <div class="form-group">
                            <label>Radius</label>
                            <input type="number" id="prop-r" value="${element.r}">
                        </div>
                        <div class="form-group">
                            <label>Fill Color</label>
                            <input type="color" id="prop-fill" value="${formatColor(element.fill)}">
                        </div>
                        <div class="form-group">
                            <label>Stroke Color</label>
                            <input type="color" id="prop-stroke" value="${formatColor(element.stroke)}">
                        </div>
                        <div class="form-group">
                            <label>Stroke Width</label>
                            <input type="number" id="prop-strokeWidth" value="${element.strokeWidth}">
                        </div>
                    `;
                    break;
                case 'path':
                    form.innerHTML += `
                        <div class="form-group">
                            <label>Path Data</label>
                            <input type="text" id="prop-d" value="${element.d}">
                        </div>
                        <div class="form-group">
                            <label>Fill Color</label>
                            <input type="color" id="prop-fill" value="${formatColor(element.fill)}">
                        </div>
                        <div class="form-group">
                            <label>Stroke Color</label>
                            <input type="color" id="prop-stroke" value="${formatColor(element.stroke)}">
                        </div>
                        <div class="form-group">
                            <label>Stroke Width</label>
                            <input type="number" id="prop-strokeWidth" value="${element.strokeWidth}">
                        </div>
                    `;
                    break;
            }

            // Add delete button
            form.innerHTML += `
                <div class="form-group">
                    <button onclick="deleteSelectedElement()">
                        <i class="fas fa-trash"></i>
                        <span>Delete Element</span>
                    </button>
                </div>
            `;

            propertiesPanel.appendChild(form);

            // Add event listeners to property inputs
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', updateElementProperty);
            });

            // Update selected state in elements list
            document.querySelectorAll('.element-item').forEach(item => {
                item.classList.remove('selected');

                // Find and select the matching element
                const elementId = item.getAttribute('data-id');
                if (elementId === element.id) {
                    item.classList.add('selected');
                }
            });
        }

        function updateElementProperty(event) {
            if (!selectedElement) return;

            const propName = event.target.id.replace('prop-', '');
            let value = event.target.value;

            // Convert numeric values
            if (['x', 'y', 'cx', 'cy', 'width', 'height', 'fontSize', 'r', 'rx', 'ry', 'strokeWidth'].includes(propName)) {
                value = parseFloat(value);
            }

            selectedElement[propName] = value;
            updateSvgPreview();
            updateElementsList();
        }

        function deleteSelectedElement() {
            if (!selectedElement) return;

            const index = svgElements.findIndex(el => el.id === selectedElement.id);
            if (index !== -1) {
                svgElements.splice(index, 1);
                selectedElement = null;

                // Clear properties panel
                const propertiesPanel = document.getElementById('element-properties');
                propertiesPanel.innerHTML = '<h3>Properties</h3><div id="no-selection-message">Select an element to edit its properties</div>';

                updateSvgPreview();
                updateElementsList();
            }
        }

        function updateSvgPreview() {
            const width = document.getElementById('width').value || 400;
            const height = document.getElementById('height').value || 400;

            // Generate SVG code
            let svgCode = `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;

            // Add elements
            svgElements.forEach(element => {
                switch (element.type) {
                    case 'text':
                        svgCode += `
                            <text 
                                x="${element.x}" 
                                y="${element.y}" 
                                font-size="${element.fontSize}" 
                                font-family="${element.fontFamily}" 
                                fill="${element.fill}" 
                                text-anchor="${element.textAnchor}"
                            >${element.text}</text>
                        `;
                        break;
                    case 'image':
                        svgCode += `
                            <image 
                                x="${element.x}" 
                                y="${element.y}" 
                                width="${element.width}" 
                                height="${element.height}" 
                                href="${element.href}"
                            />
                        `;
                        break;
                    case 'rect':
                        svgCode += `
                            <rect 
                                x="${element.x}" 
                                y="${element.y}" 
                                width="${element.width}" 
                                height="${element.height}" 
                                rx="${element.rx}" 
                                ry="${element.ry}" 
                                fill="${element.fill}" 
                                stroke="${element.stroke}" 
                                stroke-width="${element.strokeWidth}"
                            />
                        `;
                        break;
                    case 'circle':
                        svgCode += `
                            <circle 
                                cx="${element.cx}" 
                                cy="${element.cy}" 
                                r="${element.r}" 
                                fill="${element.fill}" 
                                stroke="${element.stroke}" 
                                stroke-width="${element.strokeWidth}"
                            />
                        `;
                        break;
                    case 'path':
                        svgCode += `
                            <path 
                                d="${element.d}" 
                                fill="${element.fill}" 
                                stroke="${element.stroke}" 
                                stroke-width="${element.strokeWidth}"
                            />
                        `;
                        break;
                }
            });

            svgCode += '</svg>';

            // Update code textarea
            const codeTextarea = document.getElementById('svg-code');
            codeTextarea.value = svgCode;

            // Render SVG to canvas
            renderSvgToCanvas(svgCode, width, height);

            // Update API URL
            updateApiUrl(svgCode);

            // Update content length display
            updateContentLength();
        }

        function renderSvgToCanvas(svgCode, width, height) {
            try {
                // Sanitize SVG for rendering
                // Ensure it has the proper namespace
                if (!svgCode.includes('xmlns=')) {
                    svgCode = svgCode.replace('<svg ', '<svg xmlns="http://www.w3.org/2000/svg" ');
                }

                // Create SVG blob
                const svgBlob = new Blob([svgCode], { type: 'image/svg+xml' });
                const svgUrl = URL.createObjectURL(svgBlob);

                // Get canvas and set dimensions
                const canvas = document.getElementById('preview-canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // Clear canvas with white background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, width, height);

                // Load and draw SVG on canvas
                const img = new Image();
                img.onload = function () {
                    ctx.drawImage(img, 0, 0, width, height);
                    URL.revokeObjectURL(svgUrl); // Clean up
                };

                img.onerror = function (e) {
                    console.error('Error loading SVG into canvas:', e);
                    console.error('SVG code causing error:', svgCode);

                    // Draw error message on canvas
                    ctx.fillStyle = '#ffe6e6';
                    ctx.fillRect(0, 0, width, height);
                    ctx.font = '14px Arial';
                    ctx.fillStyle = 'red';
                    ctx.textAlign = 'center';
                    ctx.fillText('Error rendering SVG', width / 2, height / 2);
                    URL.revokeObjectURL(svgUrl); // Clean up
                };

                img.src = svgUrl;
            } catch (error) {
                console.error('Error in renderSvgToCanvas:', error);

                // Draw error message on canvas
                const canvas = document.getElementById('preview-canvas');
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffe6e6';
                ctx.fillRect(0, 0, width, height);
                ctx.font = '14px Arial';
                ctx.fillStyle = 'red';
                ctx.textAlign = 'center';
                ctx.fillText('Error processing SVG', width / 2, height / 2);
            }
        }

        function updateContentLength() {
            const apiUrl = apiUrlInput.value;
            const length = apiUrl.length;

            document.getElementById('contentLength').textContent = length;

            if (length > 2000) {
                document.getElementById('contentLengthWarning').style.display = 'block';
            } else {
                document.getElementById('contentLengthWarning').style.display = 'none';
            }
        }

        function downloadImage() {
            const canvas = document.getElementById('preview-canvas');
            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = image;
            link.download = 'image.png';
            link.click();
            showToast('Image downloaded successfully');
        }

        function updateApiUrl(svgString) {
            const compressedContent = LZString.compressToEncodedURIComponent(svgString);

            // Update API URL input
            apiUrlInput.value = compressedContent
        }

        // Toast notification function
        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = document.createElement('i');
            icon.className = type === 'success' ? 'fas fa-check-circle' :
                type === 'error' ? 'fas fa-exclamation-circle' :
                    'fas fa-exclamation-triangle';

            const text = document.createElement('span');
            text.textContent = message;

            toast.appendChild(icon);
            toast.appendChild(text);
            toastContainer.appendChild(toast);

            // Remove toast after animation
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        async function copyApiUrl(urlType) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const imageId = urlParams.get('image');
                const templateId = urlParams.get('template');
                // extract {paramX} from svgCodeLabel.value
                const svgCode = svgCodeLabel.value;
                const params = svgCode.match(/{(param\d+)}/g);
                let fullUrl;
                if (templateId) {
                    fullUrl = baseUrlLabel.textContent + (urlType ?? "png") + "/" + templateId + "/" + params.map(param => param.replace('{', '').replace('}', '')).join('/');
                } else {
                    if (params && params.length > 0) {
                        console.error('Sorry, right now new templates only works for members');
                        showToast('Sorry, right now new templates only works for members', 'error');
                        return;
                    } else {
                        fullUrl = baseUrlLabel.textContent + (urlType ?? "png") + "/" + apiUrlInput.value;
                    }
                }
                await navigator.clipboard.writeText(fullUrl);
                showToast('URL copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showToast('Failed to copy URL', 'error');
            }
        }

        // Function to parse SVG string into elements array
        function parseSvgToElements(svgContent) {
            const elements = [];
            try {
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');

                // Extract elements
                const elementTypes = ['text', 'image', 'rect', 'circle', 'path'];
                elementTypes.forEach(type => {
                    const svgElements = svgDoc.querySelectorAll(type);
                    let id = 0;
                    svgElements.forEach(el => {
                        const newElement = { type, id: el.id || `${type}_${id}` };
                        id++;

                        // Copy attributes based on element type
                        switch (type) {
                            case 'text':
                                newElement.x = parseFloat(el.getAttribute('x') || 0);
                                newElement.y = parseFloat(el.getAttribute('y') || 0);
                                newElement.text = el.textContent || 'Text';
                                newElement.fontSize = parseFloat(el.getAttribute('font-size') || 24);
                                newElement.fontFamily = el.getAttribute('font-family') || 'Arial';
                                newElement.fill = el.getAttribute('fill');
                                newElement.textAnchor = el.getAttribute('text-anchor') || 'start';
                                break;
                            case 'image':
                                newElement.x = parseFloat(el.getAttribute('x') || 0);
                                newElement.y = parseFloat(el.getAttribute('y') || 0);
                                newElement.width = parseFloat(el.getAttribute('width') || 100);
                                newElement.height = parseFloat(el.getAttribute('height') || 100);
                                newElement.href = el.getAttribute('href') || '';
                                break;
                            case 'rect':
                                newElement.x = parseFloat(el.getAttribute('x') || 0);
                                newElement.y = parseFloat(el.getAttribute('y') || 0);
                                newElement.width = parseFloat(el.getAttribute('width') || 100);
                                newElement.height = parseFloat(el.getAttribute('height') || 100);
                                newElement.fill = el.getAttribute('fill');
                                newElement.stroke = el.getAttribute('stroke');
                                newElement.strokeWidth = parseFloat(el.getAttribute('stroke-width') || 2);
                                newElement.rx = parseFloat(el.getAttribute('rx') || 5);
                                newElement.ry = parseFloat(el.getAttribute('ry') || 5);
                                break;
                            case 'circle':
                                newElement.cx = parseFloat(el.getAttribute('cx') || 100);
                                newElement.cy = parseFloat(el.getAttribute('cy') || 100);
                                newElement.r = parseFloat(el.getAttribute('r') || 50);
                                newElement.fill = el.getAttribute('fill');
                                newElement.stroke = el.getAttribute('stroke');
                                newElement.strokeWidth = parseFloat(el.getAttribute('stroke-width') || 2);
                                break;
                            case 'path':
                                newElement.d = el.getAttribute('d') || '';
                                newElement.fill = el.getAttribute('fill');
                                newElement.stroke = el.getAttribute('stroke');
                                newElement.strokeWidth = parseFloat(el.getAttribute('stroke-width') || 2);
                                break;
                        }

                        elements.push(newElement);
                    });
                });

                return elements;
            } catch (error) {
                console.error('Error parsing SVG elements:', error);
                throw error;
            }
        }

        // Load collage from URL parameter
        async function loadCollageFromId() {
            const urlParams = new URLSearchParams(window.location.search);
            const imageId = urlParams.get('image');
            const templateId = urlParams.get('template');

            if (imageId) {
                try {
                    const response = await fetch(`/api/collages/${imageId}`);
                    if (response.ok) {
                        const image = await response.json();

                        // Decompress the content if it's compressed
                        let svgContent;
                        try {
                            svgContent = LZString.decompressFromEncodedURIComponent(image.content);
                            if (!svgContent) {
                                throw new Error('Invalid compressed content');
                            }
                        } catch (e) {
                            // If decompression fails, try using the content as is
                            svgContent = image.content;
                        }

                        // Update width and height
                        document.getElementById('width').value = image.width;
                        document.getElementById('height').value = image.height;

                        // Update SVG code
                        document.getElementById('svg-code').value = svgContent;

                        // Parse SVG elements
                        try {
                            svgElements = parseSvgToElements(svgContent);

                            // Update elements list and preview
                            updateElementsList();
                            updateSvgPreview();

                        } catch (parseError) {
                            console.error('Error parsing SVG elements:', parseError);
                            showToast('Error parsing SVG content', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error loading collage:', error);
                    showToast('Error loading collage', 'error');
                }
            } else if (templateId) {
                try {
                    const response = await fetch(`/api/templates/${templateId}`);
                    if (response.ok) {
                        const template = await response.json();

                        // Decompress the content if it's compressed
                        let svgContent;
                        try {
                            svgContent = LZString.decompressFromEncodedURIComponent(template.content);
                            if (!svgContent) {
                                throw new Error('Invalid compressed content');
                            }
                        } catch (e) {
                            // If decompression fails, try using the content as is
                            svgContent = template.content;
                        }

                        // Update width and height
                        document.getElementById('width').value = template.width;
                        document.getElementById('height').value = template.height;

                        // Update SVG code
                        document.getElementById('svg-code').value = svgContent;

                        // Parse SVG elements
                        try {
                            svgElements = parseSvgToElements(svgContent);

                            // Update elements list and preview
                            updateElementsList();
                            updateSvgPreview();

                        } catch (parseError) {
                            console.error('Error parsing SVG elements:', parseError);
                            showToast('Error parsing SVG content', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error loading template:', error);
                    showToast('Error loading template', 'error');
                }
            }
        }

        async function pasteFromClipboard() {
            try {
                const clipboardText = await navigator.clipboard.readText();
                let params = clipboardText;

                // If the text starts with http, extract the parameters part
                if (params.startsWith('http')) {
                    const queryIndex = params.indexOf('?');
                    if (queryIndex !== -1) {
                        params = params.substring(queryIndex + 1);
                    }
                }

                // Update the API URL input
                apiUrlInput.value = params;
                showToast('Content pasted from clipboard!');

                try {
                    // Parse the parameters
                    const urlParams = new URLSearchParams(params);
                    const width = urlParams.get('width');
                    const height = urlParams.get('height');
                    const content = urlParams.get('content');

                    if (width && height && content) {
                        // Update width and height
                        document.getElementById('width').value = width;
                        document.getElementById('height').value = height;

                        // Update SVG code
                        document.getElementById('svg-code').value = content;

                        // Parse SVG elements
                        try {
                            svgElements = parseSvgToElements(content);
                            updateElementsList();
                            updateSvgPreview();
                        } catch (parseError) {
                            console.error('Error parsing SVG elements:', parseError);
                            showToast('Error parsing SVG content', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Failed to parse clipboard content:', error);
                    showToast('Error parsing clipboard content', 'error');
                }
            } catch (err) {
                console.error('Failed to read clipboard:', err);
                showToast('Failed to read clipboard', 'error');
            }
        }

        function showSaveModal() {
            const svgCode = svgCodeLabel.value;
            // Check if the SVG code contains any template parameters
            const hasTemplateParams = /{param\d*}/.test(svgCode);
            if (hasTemplateParams) {
                document.getElementById('saveTemplateModal').style.display = 'block';
            } else {
                document.getElementById('saveImageModal').style.display = 'block';
            }
        }

        function hideSaveImageModal() {
            document.getElementById('saveImageModal').style.display = 'none';
        }

        function hideSaveTemplateModal() {
            document.getElementById('saveTemplateModal').style.display = 'none';
        }

        async function saveImage() {
            const name = document.getElementById('imageName').value.trim();
            if (!name) {
                showToast('Please enter a name for your image', 'warning');
                return;
            }

            let compressedParams = apiUrlInput.value;
            if (compressedParams.startsWith('<svg') || compressedParams.startsWith('%3Csvg')) {
                compressedParams = LZString.compressToEncodedURIComponent(compressedParams);
            }

            try {
                const response = await fetch('/api/collages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        content: compressedParams
                    })
                });

                if (response.ok) {
                    hideSaveImageModal();
                    showToast('Image saved successfully!');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Error saving image', 'error');
                }
            } catch (error) {
                console.error('Error saving image:', error);
                showToast('Error saving image', 'error');
            }
        }

        async function saveTemplate() {
            const id = document.getElementById('templateId').value.trim();
            if (!id) {
                showToast('Please enter a name for your image', 'warning');
                return;
            }

            let compressedParams = apiUrlInput.value;
            if (compressedParams.startsWith('<svg') || compressedParams.startsWith('%3Csvg')) {
                compressedParams = LZString.compressToEncodedURIComponent(compressedParams);
            }

            try {
                const response = await fetch('/api/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id,
                        content: compressedParams
                    })
                });

                if (response.ok) {
                    hideSaveTemplateModal();
                    showToast('Template saved successfully!');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Error saving template', 'error');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                showToast('Error saving template', 'error');
            }
        }

        function showQRModal() {
            const urlParams = new URLSearchParams(window.location.search);
            const imageId = urlParams.get('image');
            const templateId = urlParams.get('template');
            // extract {paramX} from svgCodeLabel.value
            const svgCode = svgCodeLabel.value;
            const params = svgCode.match(/{(param\d+)}/g);
            if (templateId) {
                // Generate QR code with the returned ID
                const qrUrl = `${window.location.origin}/image/${templateId}/${params.map(param => param.replace('{', '').replace('}', '')).join('/')}`;

                // Initialize QR code with styling
                const qrCodeElement = document.getElementById('qrCode');
                qrCodeElement.innerHTML = ''; // Clear previous QR code

                qrCode = new QRCodeStyling({
                    width: 400,
                    height: 400,
                    data: qrUrl,
                    margin: 10,
                    dotsOptions: {
                        color: '#6f5c4b',
                        type: 'rounded'
                    },
                    cornersSquareOptions: {
                        // type: 'none',
                        color: '#6f5c4b'
                    },
                    cornersDotOptions: {
                        // type: 'none',
                        color: '#6f5c4b'
                    },
                    backgroundOptions: {
                        color: '#ffffff'
                    },
                    imageOptions: {
                        crossOrigin: 'anonymous',
                        margin: 8,
                        imageSize: 0.3
                    },
                    image: '/pi-co.png'
                });

                qrCode.append(qrCodeElement);
                document.getElementById('qrModal').style.display = 'block';
            } else {
                if (params && params.length > 0) {
                    console.error('Sorry, right now new templates only works for members');
                    showToast('Sorry, right now new templates only works for members', 'error');
                    return;
                } else {
                    let compressedParams = apiUrlInput.value;
                    if (compressedParams.startsWith('<svg') || compressedParams.startsWith('%3Csvg')) {
                        compressedParams = LZString.compressToEncodedURIComponent(compressedParams);
                    }
                    // First save the QR content to get an ID
                    fetch(`/qr`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: compressedParams
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            // Generate QR code with the returned ID
                            const qrUrl = `${window.location.origin}/qr/${data.id}`;

                            // Initialize QR code with styling
                            const qrCodeElement = document.getElementById('qrCode');
                            qrCodeElement.innerHTML = ''; // Clear previous QR code

                            qrCode = new QRCodeStyling({
                                width: 400,
                                height: 400,
                                data: qrUrl,
                                margin: 10,
                                dotsOptions: {
                                    color: '#6f5c4b',
                                    type: 'rounded'
                                },
                                cornersSquareOptions: {
                                    // type: 'none',
                                    color: '#6f5c4b'
                                },
                                cornersDotOptions: {
                                    // type: 'none',
                                    color: '#6f5c4b'
                                },
                                backgroundOptions: {
                                    color: '#ffffff'
                                },
                                imageOptions: {
                                    crossOrigin: 'anonymous',
                                    margin: 8,
                                    imageSize: 0.3
                                },
                                image: '/pi-co.png'
                            });

                            qrCode.append(qrCodeElement);
                            document.getElementById('qrModal').style.display = 'block';
                        })
                        .catch(error => {
                            console.error('Error generating QR code:', error);
                            alert('Failed to generate QR code. Please try again.');
                        });
                }
            }
        }

        function hideQRModal() {
            document.getElementById('qrModal').style.display = 'none';
            const qrCodeElement = document.getElementById('qrCode');
            qrCodeElement.innerHTML = ''; // Clear QR code
        }
    </script>
</body>

</html>